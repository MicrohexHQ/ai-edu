<!--Copyright © Microsoft Corporation. All rights reserved.
  适用于[License](https://github.com/Microsoft/ai-edu/blob/master/LICENSE.md)版权许可-->

## 19.3

### 19.3.1 提出问题

大气污染治理问题迫在眉睫，否则会严重影响人类健康。如果能够根据当前的空气质量条件和气象条件，预测未来几个小时的空气质量，就会为的预警机制提供保证，以提醒人们未来几小时的出行安排。

用当前时刻的数据来预测未来的数据，也是循环神经网络的重要功能之一，它与前面学习的回归问题的重要区别在于：假设在[0,1]区间内，给定任意x值，预测y值，是属于普通的回归问题；而预测$x>1$时的y值，就属于循环神经网络的预测范畴了。

### 19.3.2 准备数据

北京空气质量数据来源于此：https://archive.ics.uci.edu，它的原始数据格式见表19-5：

|字段序号|英文名称|中文名称|取值说明|
|---|---|---|---|
|1| No |行数|1~43824|
|2| year|年|2010~2014|
|3| month|月|1~12|
|4| day|日|1~31|
|5| hour|小时|0~23|
|6| pm2.5|PM2.5浓度|0~994|
|7| DEWP|露点|-40~28|
|8| TEMP|温度|-19~42|
|9| PRES|气压|991~1046|
|10| cbwd|风向|cv,NE,NW,SE|
|11| lws|累积风速|0.45~585.6|
|12| ls|累积降雪量|0~27|
|13| lr|累积降雨量|0~36|

表19-5 气象及PM2.5数据格式

注意数据中最后三个字段都是按小时统计的累积量，以下面的数据片段为例：

```
No. 年      月  日   时 污染 露点 温 气压    风向 风速    雪  雨
-------------------------------------------------------------
22	2010	1	1	21	NA	-17	-5	1018	NW	1.79	0	0
23	2010	1	1	22	NA	-17	-5	1018	NW	2.68	0	0
24	2010	1	1	23	NA	-17	-5	1020	cv	0.89	0	0
25	2010	1	2	0	129	-16	-4	1020	SE	1.79	0	0
26	2010	1	2	1	148	-15	-4	1020	SE	2.68	0	0
27	2010	1	2	2	159	-11	-5	1021	SE	3.57	0	0
28	2010	1	2	3	181	-7	-5	1022	SE	5.36	1	0
29	2010	1	2	4	138	-7	-5	1022	SE	6.25	2	0
30	2010	1	2	5	109	-7	-6	1022	SE	7.14	3	0
31	2010	1	2	6	105	-7	-6	1023	SE	8.93	4	0
32	2010	1	2	7	124	-7	-5	1024	SE	10.72	0	0
```

第22行数据和第23行数据的风向都是NW（西北风），前者的风速为1.79米/秒，后者的数值是2.68，但是应该用$2.68-1.79=0.89$米/秒，因为2.68是累积值，表示这两个小时一直是西北风。第24行数据的风向是cv，表示风力很小且风向不明显，正处于交替阶段。可以看到第25行数据的风向就变成了SE（东南风），再往后又是持续的东南风数值的累积。

降雪量也是如此，比如第28行数据，开始降雪，到第31行数据结束，数值表示持续降雪的时长，单位为小时。

所以在处理数据时要注意把累积值变成当前值，需要用当前行的数值减去上一行的数值。

预测，可以是预测PM2.5的具体数值，也可以是预测空气质量的好坏程度，按照标准，我们可以把PM2.5的数值分为以下6个级别，如表19-6所示：

|级别|数值|
|---|---|
|0|0~50|
|1|50~100|
|2|100~150|
|3|150~200|
|4|200~300|
|5|300以上|

表19-6 PM2.5数值及级别对应




### 19.3.3 搭建网络

与19.1节和19.2节的情况不同，此次的问题并没有指定时间步的长度，而是由网络搭建者自己指定。

在本节的问题中，一天有24条的数据，意味着我们不可能用很少的时间步来训练这个循环神经网络，但是究竟用多少时间步，还需要进行试验才能确定。另外，是训练一个拟合网络来预测具体的PM2.5数值呢，还是训练一个分类网络来预测PM2.5的级别，也是一个不确定的因素。因此，需要搭建一个比较通用的网络。

“比较通用”是什么意思呢？

1. 既可以支持分类网络（二分类和多分类），也可以支持回归网络
2. 每一个时间步可以有输出并且有监督学习信号，也可以只在最后一个时间步有输出
3. 第一个时间步的前向计算中不包含前一个时间步的隐层状态值（因为前面没有时间步）
4. 最后一个时间步的反向传播中不包含下一个时间步的回传误差（因为后面没有时间步）
5. 可以指定超参数进行网络训练，如：学习率、批大小、最大训练次数、输入层尺寸、隐层神经元数量、输出层尺寸等等
6. 可以保存训练结果并可以在以后加载参数，避免重新训练





num_step = 24
```
loss=0.001830, acc=0.590085
loss=0.001074, acc=0.759333
loss=0.000618, acc=0.861587
loss=0.000372, acc=0.916618
```
num_step = 12
```
loss=0.001690, acc=0.621013
loss=0.000916, acc=0.794515
loss=0.000491, acc=0.889818
loss=0.000284, acc=0.936316
```


### 代码位置

ch19, Level3_Base